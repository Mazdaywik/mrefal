$MODULE CoreBE::OS::MFileSystem;

$NATIVE Refal5 FUNCTION
$ENTRY FileAttributes @@'
c {
c   e.$Index::FileName$ =
c     <$Local::CoreBE::OS::MFileSystem::Call$
c       ('FileAttributes') e.$Index::FileName$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
$ENTRY FindFiles @@'
c {
c   e.$Index::Mask$ =
c     <$Local::CoreBE::OS::MFileSystem::Call$
c       ('FindFiles') e.$Index::Mask$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
$ENTRY FullName @@'
c {
c   e.$Index::FileName$ =
c     <$Local::CoreBE::OS::MFileSystem::Call$
c       ('FullName') e.$Index::FileName$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
$ENTRY MakeDir @@'
c {
c   e.$Index::DirName$ =
c     <$Local::CoreBE::OS::MFileSystem::Call$
c       ('MakeDir') e.$Index::DirName$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
$ENTRY RemoveDir @@'
c {
c   e.$Index::DirName$ =
c     <$Local::CoreBE::OS::MFileSystem::Call$
c       ('RemoveDir') e.$Index::DirName$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
$ENTRY RemoveFile @@'
c {
c   e.$Index::FileName$ =
c     <$Local::CoreBE::OS::MFileSystem::Call$
c       ('RemoveFile') e.$Index::FileName$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
Call @@'
c {
c   (e.$Index::FuncName$) e.$Index::Argument$

c       , <$Local::CoreBE::OS::MFileSystem::Serialize$ e.$Index::Argument$ >
c       : e.$Index::SerializedArgument$

c       , <$Local::CoreBE::OS::MFileSystem::GetExtentExe$>
c       : e.$Index::ExtentName$

c       , <System
c           e.$Index::ExtentName$ ' '
c           e.$Index::FuncName$ ' '
c           e.$Index::SerializedArgument$ ' ~$fs_extent.tmp >NUL 2>NUL'
c         >
c       : s.$Index::RetCode1$

c       , <ExistFile '~$fs_extent.tmp' > :
c       {
c         True
c           , <Open 'r' 18 '~$fs_extent.tmp' >
c           :

c           , <Get 18 > <Close 18 >
c           : e.$Index::LoadedLine$

c          , <System 'del ~$fs_extent.tmp' >
c          : s.$Index::RetCode2$

c           , <$Local::CoreBE::OS::MFileSystem::UnSerialize$ e.$Index::LoadedLine$ > :
c           {
c             s.$Index::ConvertResult$ = $Ident::Fails$ ;

c             Success e.$Index::FunctionResult$ =
c               e.$Index::FunctionResult$ ;
c           };

c         False = $Ident::Fails$;
c       };
c }
'@@;

$NATIVE Refal5 FUNCTION
Serialize @@'
c {
c   ( $ADT::__StructureBrackets$ e.$Index::InBrackets$ )
c   e.$Index::Tail$ =
c     '('
c       <$Local::CoreBE::OS::MFileSystem::Serialize$
c         e.$Index::InBrackets$
c       >
c     ')'
c     <$Local::CoreBE::OS::MFileSystem::Serialize$
c       e.$Index::Tail$
c     >;

c   s.$Index::Atom$ e.$Index::Tail$ =
c   <$Local::CoreBE::OS::MFileSystem::DumpAtom$ s.$Index::Atom$ >
c   <$Local::CoreBE::OS::MFileSystem::Serialize$ e.$Index::Tail$ > ;

c   = ;
c }
'@@;


$NATIVE Refal5 FUNCTION
DumpAtom @@'
c {
c   s.$Index::Atom$
c     , <Type s.$Index::Atom$ >
c     :
c     {
r       // Печатные символы
c       'L' e.1 = s.$Index::Atom$ ;
c       'D' e.1 = s.$Index::Atom$ ;

r       // Идентификатор
c       'W' e.1
c          , s.$Index::Atom$ :
c          {
c            $Ident::Success$ = '#iSuccess+' ;
c            $Ident::Fails$ = '#iFails+' ;
c            $Ident::ADateTime$ = '#iADateTime+' ;
c            $Ident::CDateTime$ = '#iCDateTime+' ;
c            $Ident::MDateTime$ = '#iMDateTime+' ;
c            $Ident::Size$ = '#iSize+' ;
c            $Ident::Dir$ = '#iDir+' ;
c            s.$Index::Other$ = '#iError+' ;
c          };

r       // Число
c       'N' e.1 = '#n' <Symb s.$Index::Atom$ > '+' ;
r       // Непечатные символы
c       'P' e.1 = '#c' <Symb <Ord s.$Index::Atom$ > > '+' ;
c       'O' e.1 = '#c' <Symb <Ord s.$Index::Atom$ > > '+' ;
c     };
c }
'@@;

$NATIVE Refal5 FUNCTION
GetExtentExe @@'
c {
c   , <Dg FS-Extent > :
c     {
c        Loaded e.$Index::Extent$ = e.$Index::Extent$ ;
c        =
c          <$Local::CoreBE::OS::MFileSystem::FindExtent$
c            2 <Arg 1 >
c          >;
c     };
c }
'@@;


$NATIVE Refal5 FUNCTION
FindExtent @@'
c {
c   s.$Index::Next$
c     , <Br FS-Extent '=' Loaded 'FS-Extent.cpp.exe' >
c     :
c     = 'FS-Extent.cpp.exe' ;

c   s.$Index::Next$ '++extent:' e.$Index::Extent$
c     , <Br FS-Extent '=' Loaded e.$Index::Extent$ >
c     :
c     = e.$Index::Extent$;

c   s.$Index::Next$ e.$Index::Arg$ =
c     <$Local::CoreBE::OS::MFileSystem::FindExtent$
c       <Add s.$Index::Next$ 1 >
c       <Arg s.$Index::Next$ >
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
UnSerialize @@'
c {
c   e.$Index::String$ =
c     <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c       '$' () e.$Index::String$
c     >;
c }
'@@;


$NATIVE Refal5 FUNCTION
DoUnSerialize @@'
c {
c   t.$Index::MultiBracket$ ( e.$Index::Scanned$ )
c   '#' e.$Index::Tail$ =
c     <$Local::CoreBE::OS::MFileSystem::Escaped$
c       t.$Index::MultiBracket$ ( e.$Index::Scanned$ ) e.$Index::Tail$
c     >;

c   t.$Index::MultiBracket$ ( e.$Index::Scanned$ )
c   '(' e.$Index::Tail$ =
c     <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c       ( t.$Index::MultiBracket$ ( e.$Index::Scanned$ ) ) ( )
c       e.$Index::Tail$
c     >;

c   ( t.$Index::MultiBracket$ ( e.$Index::Scanned$ ) )
c   ( e.$Index::Inner$ ) ')' e.$Index::Tail$ =
c     <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c       t.$Index::MultiBracket$
c       ( e.$Index::Scanned$ ( $ADT::__StructureBrackets$ e.$Index::Inner$ ) )
c       e.$Index::Tail$
c     >;

r   // Нормальное завершение
c   '$' ( e.$Index::Scanned$ ) = Success e.$Index::Scanned$;

r   // Ненормальное завершение
c   '$' ( e.$Index::Scanned$ ) ')' e.$Index::Tail$ = Fails;

c   ( t.$Index::MultiBracket$ ( e.$Index::Scanned$ ) )
c   ( e.$Index::Inner$ ) =
c     Fails;

c   t.$Index::MultiBracket$ ( e.$Index::Scanned$ )
c   s.$Index::Char$ e.$Index::Tail$ =
c     <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c       t.$Index::MultiBracket$
c       ( e.$Index::Scanned$ s.$Index::Char$ )
c       e.$Index::Tail$
c     >;
c }
'@@;


$NATIVE Refal5 FUNCTION
Escaped @@'
c {
c   t.$Index::MultiBracket$ ( e.$Index::Scanned$ )
c   s.$Index::Next$ e.$Index::Tail$
c     , s.$Index::Next$ :
c     {
c       'c'
c         , <$Local::CoreBE::OS::MFileSystem::EscapedSeq$
c             ('0123456789')
c             e.$Index::Tail$
c           >
c         :
c         {
c           ( ) e.$Index::NewTail$ = Fails;

c           ( e.$Index::CharCode$ ) e.$Index::NewTail$
c             , <Chr <Numb e.$Index::CharCode$ > >
c             : s.$Index::Char$
c             =
c               <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c                 t.$Index::MultiBracket$
c                 ( e.$Index::Scanned$ s.$Index::Char$ )
c                 e.$Index::NewTail$
c               >;
c         };

c       'n'
c         , <$Local::CoreBE::OS::MFileSystem::EscapedSeq$
c             ('0123456789')
c             e.$Index::Tail$
c           >
c         :
c         {
c           ( ) e.$Index::NewTail$ = Fails;

c           ( e.$Index::StrNumber$ ) e.$Index::NewTail$
c             , <Numb e.$Index::StrNumber$ >
c             : s.$Index::Number$
c             =
c               <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c                 t.$Index::MultiBracket$
c                 ( e.$Index::Scanned$ s.$Index::Number$ )
c                 e.$Index::NewTail$
c               >;
c         };

c       'i'
c         , <$Local::CoreBE::OS::MFileSystem::EscapedSeq$
c             (
c               '0123456789-_'
c               'abcdefghijklmnopqrstuvwxyz'
c               'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
c             )
c             e.$Index::Tail$
c           >
c         :
c         {
c           ( ) e.$Index::NewTail$ = Fails;

c           ( e.$Index::StrIdent$ ) e.$Index::NewTail$
c             , <$Local::CoreBE::OS::MFileSystem::Implode$ e.$Index::StrIdent$ > :
c             {
c               Valid s.$Index::Ident$ =
c                 <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c                   t.$Index::MultiBracket$
c                   ( e.$Index::Scanned$ s.$Index::Ident$ )
c                   e.$Index::NewTail$
c                 >;

c               Invalid = Fails;
c             };
c         };

c       '_' =
c         <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c           t.$Index::MultiBracket$
c           ( e.$Index::Scanned$ ' ' )
c           e.$Index::Tail$
c         >;

c       s.$Index::Escaped$ =
c         <$Local::CoreBE::OS::MFileSystem::DoUnSerialize$
c           t.$Index::MultiBracket$
c           ( e.$Index::Scanned$ s.$Index::Escaped$ )
c           e.$Index::Tail$
c         >;
c     };

c   t.$Index::MultiBracket$ ( e.$Index::Scanned$ ) = Fails;
c }
'@@;

$NATIVE Refal5 FUNCTION
EscapedSeq @@'
c {
c   ( e.$Index::Valid$ ) e.$Index::Tail$ =
c     <$Local::CoreBE::OS::MFileSystem::DoEscapedSeq$
c       ( e.$Index::Valid$ ) ( ) e.$Index::Tail$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
DoEscapedSeq @@'
c {
c   ( e.$Index::Valid$ ) ( e.$Index::Scanned$ )
c   ' ' e.$Index::Tail$ =
c     ( e.$Index::Scanned$ ) e.$Index::Tail$ ;

c   ( e.$Index::Valid$ ) ( e.$Index::Scanned$ )
c   '+' e.$Index::Tail$ =
c     ( e.$Index::Scanned$ ) e.$Index::Tail$ ;

c   ( e.$Index::Valid-B$ s.$Index::Next$ e.$Index::Valid-E$ )
c   ( e.$Index::Scanned$ ) s.$Index::Next$ e.$Index::Tail$ =
c     <$Local::CoreBE::OS::MFileSystem::DoEscapedSeq$
c       ( e.$Index::Valid-B$ s.$Index::Next$ e.$Index::Valid-E$ )
c       ( e.$Index::Scanned$ s.$Index::Next$ ) e.$Index::Tail$
c     >;
c }
'@@;

$NATIVE Refal5 FUNCTION
Implode @@'
c {
r   // Ага, хуйня на постном масле
c   'Success'        = Valid   $Ident::Success$    ;
c   'Fails'          = Valid   $Ident::Fails$      ;
c   'ADateTime'      = Valid   $Ident::ADateTime$  ;
c   'CDateTime'      = Valid   $Ident::CDateTime$  ;
c   'MDateTime'      = Valid   $Ident::MDateTime$  ;
c   'Size'           = Valid   $Ident::Size$       ;
c   'Dir'            = Valid   $Ident::Dir$        ;
c   e.$Index::Other$ = Invalid                     ;
c }
'@@;

$END CoreBE::OS::MFileSystem.
